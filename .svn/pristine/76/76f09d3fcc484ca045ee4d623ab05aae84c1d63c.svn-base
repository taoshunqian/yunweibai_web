<template>
  <TabHeaders :navTitle="navTitle" :leftArrow="false" :lavelMuch="true" />

  <CellGroup inset class="cell-group">
    <Cell :title="$t('TemperatureSensingStateDetails.template[0]')">
      <template #right-icon>
        <Checkbox v-model="OneWireTable[0]" shape="square"></Checkbox>
      </template>
    </Cell>
  </CellGroup>

  <CellGroup inset class="cell-group">
    <Field
      :label="$t('TemperatureSensingStateDetails.template[1]')"
      :placeholder="$t('TemperatureSensingStateDetails.templatePlaceholder[0]')"
      v-model="OneWireTable[1]"
      input-align="right"
    />
  </CellGroup>

  <CellGroup inset class="cell-group">
    <Field
      :label="$t('TemperatureSensingStateDetails.template[2]')"
      :placeholder="$t('TemperatureSensingStateDetails.templatePlaceholder[1]')"
      v-model="OneWireTable[2]"
      input-align="right"
    />
  </CellGroup>

  <CellGroup inset class="cell-group">
    <Cell :title="$t('TemperatureSensingStateDetails.template[3]')">
      <template #right-icon>
        <Checkbox v-model="OneWireTable[3]" shape="square"></Checkbox>
      </template>
    </Cell>
  </CellGroup>
  <!-- 温度上限 -->
  <CellGroup inset class="cell-group">
    <Field
      :label="$t('TemperatureSensingStateDetails.template[4]')"
      v-model="OneWireTable[4]"
      :placeholder="$t('TemperatureSensingStateDetails.templatePlaceholder[2]')"
      input-align="right"
    />
  </CellGroup>
  <!-- 温度下限报警功能 -->
  <CellGroup inset class="cell-group">
    <Cell :title="$t('TemperatureSensingStateDetails.template[5]')">
      <template #right-icon>
        <Checkbox v-model="OneWireTable[5]" shape="square"></Checkbox>
      </template>
    </Cell>
  </CellGroup>
  <!-- 温度下限 -->
  <CellGroup inset class="cell-group">
    <Field
      :label="$t('TemperatureSensingStateDetails.template[6]')"
      v-model="OneWireTable[6]"
      :placeholder="$t('TemperatureSensingStateDetails.templatePlaceholder[3]')"
      input-align="right"
    />
  </CellGroup>

  <CellGroup inset class="cell-group">
    <Cell :title="$t('TemperatureSensingStateDetails.template[7]')">
      <template #right-icon>
        <Checkbox shape="square" v-model="OneWireTable[7]"></Checkbox>
      </template>
    </Cell>
  </CellGroup>

  <!-- <CellGroup inset class="cell-group">
    <Field
      label="报警输出IO个数"
      label-width="150"
      v-model="OneWireTable[8]"
      placeholder="请输入IO个数"
      input-align="right"
    />
  </CellGroup> -->

  <CellGroup inset class="cell-group">
    <Field
      :label="$t('TemperatureSensingStateDetails.template[8]')"
      label-width="150"
      :placeholder="$t('TemperatureSensingStateDetails.templatePlaceholder[4]')"
      v-model="OneWireTable[10]"
      input-align="right"
    />
  </CellGroup>

  <CellGroup inset class="cell-group">
    <Cell :title="$t('TemperatureSensingStateDetails.template[9]')">
      <template #right-icon>
        <div style="width: 150px">
          <CheckboxGroup v-model="checked" direction="horizontal">
            <Checkbox
              :name="item"
              shape="square"
              v-for="(item, index) in ioNumber"
              :key="index"
              style="margin-bottom: 8px"
              >{{ item }}</Checkbox
            >
          </CheckboxGroup>
        </div>
      </template>
    </Cell>
  </CellGroup>

  <StickyBottom
    :guide="guide"
    @BottomSubmit="BottomSubmit"
    @BottomSearch="BottomSearch"
    @BottomNext="BottomNext"
  />
</template>


<script setup>

import { Cell, CellGroup, Field, Checkbox, CheckboxGroup } from "vant";
import { defineComponent, ref, onMounted } from "vue";
import { baseChange, keepDecimal } from "@/utlis/QueryStr";
import mixins from '@/mixins/index.js'
let {  t, postAN, TabHeaders,StickyBottom,useRoute,callJSResult_Status }= mixins();

let route = useRoute();
const query = route.query;

const number = query.number ?? 0;

const navTitle = ref(t("TemperatureSensingStateDetails.navTitle") + number);
const OneWireTable = ref([]);
const checked = ref([]);
const ioNumber = ref(1);
var filterIndexs = [0, 3, 5, 7];

// 查询按钮
const BottomSearch = () => {
  androidStatus_fn();
};

//
const BottomSubmit = () => {
  var cmdArr = [...OneWireTable.value];
  var basicCmd = [];
  cmdArr.forEach((item, index) => {
    if (index != 8) {
      if (filterIndexs.includes(index)) {
        basicCmd.push(+item);
      } else {
        basicCmd.push(item);
      }
    }
  });

  var btn = [...checked.value];
  var btnStr = "";
  for (var i = 1; i <= ioNumber.value; i++) {
    if (btn.includes(i)) {
      btnStr += "1";
    } else {
      btnStr += "0";
    }
  }
  var cmdRes = btnStr.split("").reverse().join("");
  basicCmd[8] = parseInt(cmdRes, 2);
  var cmd = "$ONEWIRETEMPERASET," + number + "," + basicCmd.toString();
  console.log(cmd);
  postAN.ANsendSetting(cmd);
};

const filterBasicBool = (val) => {
  var bool = !!+val;
  return bool;
};

// 命名空间
defineComponent({
  name: "yunweibao-TemperatureSensingStateDetails",
});

// -------------------------------------------------------------------
// 安卓回调函数r
const callJSResult = (str) => {
  var cmds = str.split(";")[0];
  var cmdArr = cmds.split(",").splice(1);
  // eslint-disable-next-line no-redeclare
  var cmds = [];

  cmdArr.forEach((item, index) => {
    if (filterIndexs.includes(index)) {
      var it = filterBasicBool(item);
      cmds.push(it);
    } else {
      if (index == 8) {
        var is = item.split("*");
        cmds.push(...is);
      } else {
        cmds.push(item);
      }
    }
  });
  ioNumber.value = +cmds[8];
  var IOBtn = baseChange(cmds[9], ioNumber.value).reverse();

  var selectBtn = [];
  var leng = IOBtn.length;

  for (var i = 0; i < leng; i++) {
    if (IOBtn[i] != 0) {
      selectBtn.push(i + 1);
    }
  }
  checked.value = selectBtn;
  cmds[6] = keepDecimal(cmds[6],2);
  cmds[4] =  keepDecimal(cmds[4],2);
  
  OneWireTable.value = cmds;
};

// 向安卓发送指令
const androidStatus_fn = () => {
  postAN.ANSend("$ONEWIRETEMPERAGET," + number);
};


onMounted(() => {
  androidStatus_fn();
  window.callJSResult = callJSResult;
  window.callJSResult_Status = callJSResult_Status;
});
</script>

<style scoped lang="scss">
ul {
  li {
    margin-bottom: 5px;
  }
}
.cell-group {
  margin-top: 10px;
}
</style>